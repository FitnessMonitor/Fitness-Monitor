   1               	# 1 "xitoa.S"
   1               	;---------------------------------------------------------------------------;
   0               	
   0               	
   2               	; Extended itoa, puts, printf and atoi                     (C)ChaN, 2006
   3               	;
   4               	; Module size: 277/261 words (max)
   5               	;
   6               	
  17               	.list
  18               	
  19               	#ifdef SPM_PAGESIZE	// Recent devices have "lpm Rd,Z+" and "movw".
  20               	.macro	_LPMI	reg
  21               		lpm	\reg, Z+
  22               	.endm
  23               	.macro	_MOVW	dh,dl, sh,sl
  24               		movw	\dl, \sl
  25               	.endm
  26               	#else			// Earlier devices do not have "lpm Rd,Z+" nor "movw".
  27               	.macro	_LPMI	reg
  28               		lpm
  29               		mov	\reg, r0
  30               		adiw	ZL, 1
  31               	.endm
  32               	.macro	_MOVW	dh,dl, sh,sl
  33               		mov	\dl, \sl
  34               		mov	\dh, \sh
  35               	.endm
  36               	#endif
  37               	
  38               	
  39               	
  40               	;---------------------------------------------------------------------------
  41               	; Stub function to forward to user output function
  42               	;
  43               	;Prototype: void xputc (char chr	// a character to be output
  44               	;			);
  45               	;Size: 17/17 words
  46               	
  47               	.section .bss
  48               	
  49               	.global xfunc_out	; xfunc_out must be initialized before using this module.
  50 0000 0000      	xfunc_out:	.ds.w	1
  51               	
  52               	.section .text
  53               	
  54               	
  55               	.global xputc
  56               	.func xputc
  57               	xputc:
  58               	#ifdef CR_CRLF
  58:xitoa.S       **** 	cpi	r24, 10		;LF --> CRLF
  59:xitoa.S       **** 	brne	1f		;
  60:xitoa.S       **** 	ldi	r24, 13		;
  61:xitoa.S       **** 	rcall	1f		;
  62:xitoa.S       **** 	ldi	r24, 10		;/
  64               	1:
  65               	#endif
  65:xitoa.S       **** 	push	ZH
  66:xitoa.S       **** 	push	ZL
  67:xitoa.S       **** 	lds	ZL, xfunc_out+0	;Pointer to the registered output function.
  68:xitoa.S       **** 	lds	ZH, xfunc_out+1	;/
  69:xitoa.S       **** 	sbiw	ZL, 0
  70:xitoa.S       **** 	breq	2f
  71:xitoa.S       **** 	icall
  72:xitoa.S       **** 2:	pop	ZL
  73:xitoa.S       **** 	pop	ZH
  74:xitoa.S       **** 	ret
  76               	.endfunc
  77               	
  78               	
  79               	
  80               	;---------------------------------------------------------------------------
  81               	; Direct ROM string output
  82               	;
  83               	;Prototype: void xputs (const prog_char *str // rom string to be output
  84               	;			);
  85               	;Size: 10/7 words
  86               	
  87               	#ifdef USE_XPUTS
  88               	.global xputs
  89               	.func xputs
  90               	xputs:
  90:xitoa.S       **** 	_MOVW	ZH,ZL, r25,r24	; Z = pointer to rom string
  91:xitoa.S       **** 1:	_LPMI	r24
  92:xitoa.S       **** 	cpi	r24, 0
  93:xitoa.S       **** 	breq	2f
  94:xitoa.S       **** 	rcall	xputc
  95:xitoa.S       **** 	rjmp	1b
  96:xitoa.S       **** 2:	ret
  98               	.endfunc
  99               	#endif
 100               	
 101               	
 102               	;---------------------------------------------------------------------------
 103               	; Extended direct numeral string output (32bit version)
 104               	;
 105               	;Prototype: void xitoa (long value,	// value to be output
 106               	;                       char radix,	// radix
 107               	;                       char width);	// minimum width
 108               	;Size: 59/59 words
 109               	;
 110               	
 111               	#ifdef USE_XITOA
 112               	.global xitoa
 113               	.func xitoa
 114               	xitoa:
 115               					;r25:r22 = value, r20 = base, r18 = digits
 115:xitoa.S       **** 	clr	r31		;r31 = stack level
 116:xitoa.S       **** 	ldi	r30, ' '	;r30 = sign
 117:xitoa.S       **** 	ldi	r19, ' '	;r19 = filler
 118:xitoa.S       **** 	sbrs	r20, 7		;When base indicates signd format and the value
 119:xitoa.S       **** 	rjmp	0f		;is minus, add a '-'.
 120:xitoa.S       **** 	neg	r20		;
 121:xitoa.S       **** 	sbrs	r25, 7		;
 122:xitoa.S       **** 	rjmp	0f		;
 123:xitoa.S       **** 	ldi	r30, '-'	;
 124:xitoa.S       **** 	com	r22		;
 125:xitoa.S       **** 	com	r23		;
 126:xitoa.S       **** 	com	r24		;
 127:xitoa.S       **** 	com	r25		;
 128:xitoa.S       **** 	adc	r22, r1		;
 129:xitoa.S       **** 	adc	r23, r1		;
 130:xitoa.S       **** 	adc	r24, r1		;
 131:xitoa.S       **** 	adc	r25, r1		;/
 132:xitoa.S       **** 0:	sbrs	r18, 7		;When digits indicates zero filled,
 133:xitoa.S       **** 	rjmp	1f		;filler is '0'.
 134:xitoa.S       **** 	neg	r18		;
 135:xitoa.S       **** 	ldi	r19, '0'	;/
 137               					;----- string conversion loop
 137:xitoa.S       **** 1:	ldi	r21, 32		;r26 = r25:r22 % r20
 138:xitoa.S       **** 	clr	r26		;r25:r22 /= r20
 139:xitoa.S       **** 2:	lsl	r22		;
 140:xitoa.S       **** 	rol	r23		;
 141:xitoa.S       **** 	rol	r24		;
 142:xitoa.S       **** 	rol	r25		;
 143:xitoa.S       **** 	rol	r26		;
 144:xitoa.S       **** 	cp	r26, r20	;
 145:xitoa.S       **** 	brcs	3f		;
 146:xitoa.S       **** 	sub	r26, r20	;
 147:xitoa.S       **** 	inc	r22		;
 148:xitoa.S       **** 3:	dec	r21		;
 149:xitoa.S       **** 	brne	2b		;/
 150:xitoa.S       **** 	cpi	r26, 10		;r26 is a numeral digit '0'-'F'
 151:xitoa.S       **** 	brcs	4f		;
 152:xitoa.S       **** 	subi	r26, -7		;
 153:xitoa.S       **** 4:	subi	r26, -'0'	;/
 154:xitoa.S       **** 	push	r26		;Stack it
 155:xitoa.S       **** 	inc	r31		;/
 156:xitoa.S       **** 	cp	r22, r1		;Repeat until r25:r22 gets zero
 157:xitoa.S       **** 	cpc	r23, r1		;
 158:xitoa.S       **** 	cpc	r24, r1		;
 159:xitoa.S       **** 	cpc	r25, r1		;
 160:xitoa.S       **** 	brne	1b		;/
 162               	
 162:xitoa.S       **** 	cpi	r30, '-'	;Minus sign if needed
 163:xitoa.S       **** 	brne	5f		;
 164:xitoa.S       **** 	push	r30		;
 165:xitoa.S       **** 	inc	r31		;/
 166:xitoa.S       **** 5:	cp	r31, r18	;Filler
 167:xitoa.S       **** 	brcc	6f		;
 168:xitoa.S       **** 	push	r19		;
 169:xitoa.S       **** 	inc	r31		;
 170:xitoa.S       **** 	rjmp	5b		;/
 172               	
 172:xitoa.S       **** 6:	pop	r24		;Flush stacked digits and exit
 173:xitoa.S       **** 	rcall	xputc		;
 174:xitoa.S       **** 	dec	r31		;
 175:xitoa.S       **** 	brne	6b		;/
 177               	
 177:xitoa.S       **** 	ret
 179               	.endfunc
 180               	#endif
 181               	
 182               	
 183               	
 184               	;---------------------------------------------------------------------------;
 185               	; Formatted string output (16/32bit version)
 186               	;
 187               	;Prototype:
 188               	; void xprintf (const prog_char *format, ...);
 189               	;Size: 104/94 words
 190               	;
 191               	
 192               	#ifdef USE_XPRINTF
 193               	.global xprintf
 194               	.func xprintf
 195               	xprintf:
 195:xitoa.S       **** 	push	YH
 196:xitoa.S       **** 	push	YL
 197:xitoa.S       **** 	in	YL, _SFR_IO_ADDR(SPL)
 199               	#ifdef SPH
 199:xitoa.S       **** 	in	YH, _SFR_IO_ADDR(SPH)
 201               	#else
 202               		clr	YH
 203               	#endif
 204               	#if FLASHEND > 0x1FFFF
 205               		adiw	YL, 6		;Y = pointer to arguments
 206               	#else
 206:xitoa.S       **** 	adiw	YL, 5		;Y = pointer to arguments
 208               	#endif
 208:xitoa.S       **** 	ld	ZL, Y+		;Z = pointer to format string
 209:xitoa.S       **** 	ld	ZH, Y+		;/
 211               	
 211:xitoa.S       **** 0:	_LPMI	r24		;Get a format char
 212:xitoa.S       **** 	cpi	r24, 0		;End of format string?
 213:xitoa.S       **** 	breq	90f		;/
 214:xitoa.S       **** 	cpi	r24, '%'	;Is format?
 215:xitoa.S       **** 	breq	20f		;/
 216:xitoa.S       **** 1:	rcall	xputc		;Put a normal character
 217:xitoa.S       **** 	rjmp	0b		;/
 218:xitoa.S       **** 90:	pop	YL
 219:xitoa.S       **** 	pop	YH
 220:xitoa.S       **** 	ret
 222               	
 222:xitoa.S       **** 20:	ldi	r18, 0		;r18: digits
 223:xitoa.S       **** 	clt			;T: filler
 224:xitoa.S       **** 	_LPMI	r21		;Get flags
 225:xitoa.S       **** 	cpi	r21, '%'	;Is a %?
 226:xitoa.S       **** 	breq	1b		;/
 227:xitoa.S       **** 	cpi	r21, '0'	;Zero filled?
 228:xitoa.S       **** 	brne	23f		;
 229:xitoa.S       **** 	set			;/
 230:xitoa.S       **** 22:	_LPMI	r21		;Get width
 231:xitoa.S       **** 23:	cpi	r21, '9'+1	;
 232:xitoa.S       **** 	brcc	24f		;
 233:xitoa.S       **** 	subi	r21, '0'	;
 234:xitoa.S       **** 	brcs	90b		;
 235:xitoa.S       **** 	lsl	r18		;
 236:xitoa.S       **** 	mov	r0, r18		;
 237:xitoa.S       **** 	lsl	r18		;
 238:xitoa.S       **** 	lsl	r18		;
 239:xitoa.S       **** 	add	r18, r0		;
 240:xitoa.S       **** 	add	r18, r21	;
 241:xitoa.S       **** 	rjmp	22b		;/
 243               	
 243:xitoa.S       **** 24:	brtc	25f		;get value (low word)
 244:xitoa.S       **** 	neg	r18		;
 245:xitoa.S       **** 25:	ld	r24, Y+		;
 246:xitoa.S       **** 	ld	r25, Y+		;/
 247:xitoa.S       **** 	cpi	r21, 'c'	;Is type character?
 248:xitoa.S       **** 	breq	1b		;/
 249:xitoa.S       **** 	cpi	r21, 's'	;Is type RAM string?
 250:xitoa.S       **** 	breq	50f		;/
 251:xitoa.S       **** 	cpi	r21, 'S'	;Is type ROM string?
 252:xitoa.S       **** 	breq	60f		;/
 253:xitoa.S       **** 	_MOVW	r23,r22,r25,r24	;r25:r22 = value
 254:xitoa.S       **** 	clr	r24		;
 255:xitoa.S       **** 	clr	r25		;
 256:xitoa.S       **** 	clt			;/
 257:xitoa.S       **** 	cpi	r21, 'l'	;Is long int?
 258:xitoa.S       **** 	brne	26f		;
 259:xitoa.S       **** 	ld	r24, Y+		;get value (high word)
 260:xitoa.S       **** 	ld	r25, Y+		;
 261:xitoa.S       **** 	set			;
 262:xitoa.S       **** 	_LPMI	r21		;/
 263:xitoa.S       **** 26:	cpi	r21, 'd'	;Is type signed decimal?
 264:xitoa.S       **** 	brne	27f		;/
 265:xitoa.S       **** 	ldi	r20, -10	;
 266:xitoa.S       **** 	brts	40f		;
 267:xitoa.S       **** 	sbrs	r23, 7		;
 268:xitoa.S       **** 	rjmp	40f		;
 269:xitoa.S       **** 	ldi	r24, -1		;
 270:xitoa.S       **** 	ldi	r25, -1		;
 271:xitoa.S       **** 	rjmp	40f		;/
 272:xitoa.S       **** 27:	cpi	r21, 'u'	;Is type unsigned decimal?
 273:xitoa.S       **** 	ldi	r20, 10		;
 274:xitoa.S       **** 	breq	40f		;/
 275:xitoa.S       **** 	cpi	r21, 'X'	;Is type hexdecimal?
 276:xitoa.S       **** 	ldi	r20, 16		;
 277:xitoa.S       **** 	breq	40f		;/
 278:xitoa.S       **** 	cpi	r21, 'b'	;Is type binary?
 279:xitoa.S       **** 	ldi	r20, 2		;
 280:xitoa.S       **** 	breq	40f		;/
 281:xitoa.S       **** 	rjmp	90b		;abort
 282:xitoa.S       **** 40:	push	ZH		;Output the value
 283:xitoa.S       **** 	push	ZL		;
 284:xitoa.S       **** 	rcall	xitoa		;
 285:xitoa.S       **** 42:	pop	ZL		;
 286:xitoa.S       **** 	pop	ZH		;
 287:xitoa.S       **** 	rjmp	0b		;/
 289               	
 289:xitoa.S       **** 50:	push	ZH		;Put a string on the RAM
 290:xitoa.S       **** 	push	ZL
 291:xitoa.S       **** 	_MOVW	ZH,ZL, r25,r24
 292:xitoa.S       **** 51:	ld	r24, Z+
 293:xitoa.S       **** 	cpi	r24, 0
 294:xitoa.S       **** 	breq	42b
 295:xitoa.S       **** 	rcall	xputc
 296:xitoa.S       **** 	rjmp	51b
 298               	
 298:xitoa.S       **** 60:	push	ZH		;Put a string on the ROM
 299:xitoa.S       **** 	push	ZL
 300:xitoa.S       **** 	rcall	xputs
 301:xitoa.S       **** 	rjmp	42b
 303               	
 304               	.endfunc
 305               	#endif
 306               	
 307               	
 308               	
 309               	;---------------------------------------------------------------------------
 310               	; Extended numeral string input
 311               	;
 312               	;Prototype:
 313               	; char xatoi (           /* 1: Successful, 0: Failed */
 314               	;      const char **str, /* pointer to pointer to source string */
 315               	;      long *res         /* result */
 316               	; );
 317               	;Size: 94/91 words
 318               	;
 319               	
 320               	#ifdef USE_XATOI
 321               	.global xatoi
 322               	.func xatoi
 323               	xatoi:
 323:xitoa.S       **** 	_MOVW	r1, r0, r23, r22
 324:xitoa.S       **** 	_MOVW	XH, XL, r25, r24
 325:xitoa.S       **** 	ld	ZL, X+
 326:xitoa.S       **** 	ld	ZH, X+
 327:xitoa.S       **** 	clr	r18		;r21:r18 = 0;
 328:xitoa.S       **** 	clr	r19		;
 329:xitoa.S       **** 	clr	r20		;
 330:xitoa.S       **** 	clr	r21		;/
 331:xitoa.S       **** 	clt			;T = 0;
 333               	
 333:xitoa.S       **** 	ldi	r25, 10		;r25 = 10;
 334:xitoa.S       **** 	rjmp	41f		;/
 335:xitoa.S       **** 40:	adiw	ZL, 1		;Z++;
 336:xitoa.S       **** 41:	ld	r22, Z		;r22 = *Z;
 337:xitoa.S       **** 	cpi	r22, ' '	;if(r22 == ' ') continue
 338:xitoa.S       **** 	breq	40b		;/
 339:xitoa.S       **** 	brcs	70f		;if(r22 < ' ') error;
 340:xitoa.S       **** 	cpi	r22, '-'	;if(r22 == '-') {
 341:xitoa.S       **** 	brne	42f		; T = 1;
 342:xitoa.S       **** 	set			; continue;
 343:xitoa.S       **** 	rjmp	40b		;}
 344:xitoa.S       **** 42:	cpi	r22, '9'+1	;if(r22 > '9') error;
 345:xitoa.S       **** 	brcc	70f		;/
 346:xitoa.S       **** 	cpi	r22, '0'	;if(r22 < '0') error;
 347:xitoa.S       **** 	brcs	70f		;/
 348:xitoa.S       **** 	brne	51f		;if(r22 > '0') cv_start;
 349:xitoa.S       **** 	ldi	r25, 8		;r25 = 8;
 350:xitoa.S       **** 	adiw	ZL, 1		;r22 = *(++Z);
 351:xitoa.S       **** 	ld	r22, Z		;/
 352:xitoa.S       **** 	cpi	r22, ' '+1	;if(r22 <= ' ') exit;
 353:xitoa.S       **** 	brcs	80f		;/
 354:xitoa.S       **** 	cpi	r22, 'b'	;if(r22 == 'b') {
 355:xitoa.S       **** 	brne	43f		; r25 = 2;
 356:xitoa.S       **** 	ldi	r25, 2		; cv_start;
 357:xitoa.S       **** 	rjmp	50f		;}
 358:xitoa.S       **** 43:	cpi	r22, 'x'	;if(r22 != 'x') error;
 359:xitoa.S       **** 	brne	51f		;/
 360:xitoa.S       **** 	ldi	r25, 16		;r25 = 16;
 362               	
 362:xitoa.S       **** 50:	adiw	ZL, 1		;Z++;
 363:xitoa.S       **** 	ld	r22, Z		;r22 = *Z;
 364:xitoa.S       **** 51:	cpi	r22, ' '+1	;if(r22 <= ' ') break;
 365:xitoa.S       **** 	brcs	80f		;/
 366:xitoa.S       **** 	cpi	r22, 'a'	;if(r22 >= 'a') r22 =- 0x20;
 367:xitoa.S       **** 	brcs	52f		;
 368:xitoa.S       **** 	subi	r22, 0x20	;/
 369:xitoa.S       **** 52:	subi	r22, '0'	;if((r22 -= '0') < 0) error;
 370:xitoa.S       **** 	brcs	70f		;/
 371:xitoa.S       **** 	cpi	r22, 10		;if(r22 >= 10) {
 372:xitoa.S       **** 	brcs	53f		; r22 -= 7;
 373:xitoa.S       **** 	subi	r22, 7		; if(r22 < 10) 
 374:xitoa.S       **** 	cpi	r22, 10		;
 375:xitoa.S       **** 	brcs	70f		;}
 376:xitoa.S       **** 53:	cp	r22, r25	;if(r22 >= r25) error;
 377:xitoa.S       **** 	brcc	70f		;/
 378:xitoa.S       **** 60:	ldi	r24, 33		;r21:r18 *= r25;
 379:xitoa.S       **** 	sub	r23, r23	;
 380:xitoa.S       **** 61:	brcc	62f		;
 381:xitoa.S       **** 	add	r23, r25	;
 382:xitoa.S       **** 62:	lsr	r23		;
 383:xitoa.S       **** 	ror	r21		;
 384:xitoa.S       **** 	ror	r20		;
 385:xitoa.S       **** 	ror	r19		;
 386:xitoa.S       **** 	ror	r18		;
 387:xitoa.S       **** 	dec	r24		;
 388:xitoa.S       **** 	brne	61b		;/
 389:xitoa.S       **** 	add	r18, r22	;r21:r18 += r22;
 390:xitoa.S       **** 	adc	r19, r24	;
 391:xitoa.S       **** 	adc	r20, r24	;
 392:xitoa.S       **** 	adc	r21, r24	;/
 393:xitoa.S       **** 	rjmp	50b		;repeat
 395               	
 395:xitoa.S       **** 70:	ldi	r24, 0
 396:xitoa.S       **** 	rjmp	81f
 397:xitoa.S       **** 80:	ldi	r24, 1
 398:xitoa.S       **** 81:	brtc	82f
 399:xitoa.S       **** 	clr	r22
 400:xitoa.S       **** 	com	r18
 401:xitoa.S       **** 	com	r19
 402:xitoa.S       **** 	com	r20
 403:xitoa.S       **** 	com	r21
 404:xitoa.S       **** 	adc	r18, r22
 405:xitoa.S       **** 	adc	r19, r22
 406:xitoa.S       **** 	adc	r20, r22
 407:xitoa.S       **** 	adc	r21, r22
 408:xitoa.S       **** 82:	st	-X, ZH
 409:xitoa.S       **** 	st	-X, ZL
 410:xitoa.S       **** 	_MOVW	XH, XL, r1, r0
 411:xitoa.S       **** 	st	X+, r18
 412:xitoa.S       **** 	st	X+, r19
 413:xitoa.S       **** 	st	X+, r20
 414:xitoa.S       **** 	st	X+, r21
 415:xitoa.S       **** 	clr	r1
 416:xitoa.S       **** 	ret
 418               	.endfunc
DEFINED SYMBOLS
             xitoa.S:50     .bss:00000000 xfunc_out
             xitoa.S:57     .text:00000000 xputc
             xitoa.S:90     .text:00000022 xputs
             xitoa.S:114    .text:00000030 xitoa
             xitoa.S:195    .text:000000a6 xprintf
             xitoa.S:323    .text:00000162 xatoi

NO UNDEFINED SYMBOLS
